using ERFA
using Compat

@testset "States" begin
    @testset "State type" begin
        ep = TTEpoch(2000, 1, 1)
        tdb = TDBEpoch(ep)
        @test State(ep, ones(6)) == State(ep, ones(6), GCRF, Earth)
        @test State(ep, ones(6)) ≈ State(ep, ones(6)+eps(), GCRF, Earth)
        rv = [ones(3)*7e3; ones(3)]
        s = State(TTEpoch(2000,1,1), ones(3)*7e3, ones(3))
        M = rotation_matrix(IAU{Earth}, GCRF, tdb)
        earth = state(Earth, tdb)
        mars = state(Mars, tdb)
        @test State(s, frame=IAU{Earth}) == State(ep, M*rv, IAU{Earth})
        @test s ≈ State(State(s, frame=IAU{Earth}), frame=GCRF)
        @test State(s, timescale=TDB) == State(tdb, rv)
        @test State(s, body=Mars) == State(ep, rv+earth-mars, GCRF, Mars)
        @test State(s, timescale=TDB, body=Mars) == State(tdb, rv+earth-mars, GCRF, Mars)
        @test State(s, frame=IAU{Earth}, body=Mars) ≈ State(ep, M*(rv+earth-mars), IAU{Earth}, Mars)
        @test State(s, frame=IAU{Earth}, timescale=TDB) == State(tdb, M*rv, IAU{Earth})
        mars_rot = State(tdb, rv, IAU{Mars}, Mars)
        @test State(State(mars_rot, body=Earth), body=Mars) ≈ mars_rot
        @test State(State(mars_rot, frame=ITRF, body=Earth), frame=IAU{Mars}, body=Mars) ≈ mars_rot
        @test State(State(mars_rot, frame=ITRF, timescale=UT1, body=Earth), frame=IAU{Mars}, timescale=TDB, body=Mars) ≈ mars_rot
    end
    @testset "IAU rotations" begin
        # Reference data form WebGeocalc (http://wgc.jpl.nasa.gov/)
        ep = Epoch(TDB, 2000, 1, 1, 12) + EpochDelta(seconds=1000)
        matrices = Dict("Mercury" => reshape([
            0.93161546
            -0.27117375
            -0.24198643
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            0.35177121
            0.84016564
            0.41276956
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            0.09137641
            -0.46966636
            0.87810242
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            4.36141153E-07
            1.04167363E-06
            5.11769580E-07
            0.93161546
            -0.27117375
            -0.24198643
            -1.15505708E-06
            3.36212903E-07
            3.00025285E-07
            0.35177121
            0.84016564
            0.41276956
            -8.06548746E-14
            -3.99346680E-14
            -1.29666162E-14
            0.09137641
            -0.46966636
            0.87810242
        ], (6, 6))',
        "Venus" => reshape([
            -0.95473270
            0.26677448
            0.13159348
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            -0.29687729
            -0.88233398
            -0.36517205
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            0.01869081
            -0.38770881
            0.92159239
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            8.88390262E-08
            2.64033981E-07
            1.09275888E-07
            -0.95473270
            0.26677448
            0.13159348
            -2.85698932E-07
            7.98309152E-08
            3.93786831E-08
            -0.29687729
            -0.88233398
            -0.36517205
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            0.01869081
            -0.38770881
            0.92159239
        ], (6, 6))',
        "Earth" => reshape([
            0.24742306
            -0.96890755
            -7.62199719E-10
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            0.96890755
            0.24742306
            -2.98477054E-09
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            3.08055248E-09
            -1.09209406E-17
            1.00000000
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            7.06538526E-05
            1.80423738E-05
            -9.79852602E-13
            0.24742306
            -0.96890755
            -7.62199719E-10
            -1.80423738E-05
            7.06538526E-05
            -2.92918995E-12
            0.96890755
            0.24742306
            -2.98477054E-09
            3.08055237E-12
            -2.18418808E-20
            -9.48980323E-21
            3.08055248E-09
            -1.09209406E-17
            1.00000000
        ], (6, 6))',
        "Mars" => reshape([
            -0.66608963
            -0.74583619
            -0.00727954
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            0.59771816
            -0.52791987
            -0.60335198
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            0.44615873
            -0.40623761
            0.79744178
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            4.23675661E-05
            -3.74201109E-05
            -4.27669044E-05
            -0.66608963
            -0.74583619
            -0.00727954
            4.72138849E-05
            5.28664951E-05
            5.15989714E-07
            0.59771816
            -0.52791987
            -0.60335198
            -3.97806628E-14
            -4.42633886E-13
            -2.03232447E-13
            0.44615873
            -0.40623761
            0.79744178
        ], (6, 6))',
        "Jupiter" => reshape([
            0.39505525
            -0.83169183
            -0.39015388
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            0.91854138
            0.35086343
            0.18214441
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            -0.01459729
            -0.43032959
            0.90255380
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            0.00016153
            6.17004691E-05
            3.20306845E-05
            0.39505525
            -0.83169183
            -0.39015388
            -6.94717442E-05
            0.00014626
            6.86098223E-05
            0.91854138
            0.35086343
            0.18214441
            -5.69989759E-14
            4.64700233E-15
            1.29378658E-15
            -0.01459729
            -0.43032959
            0.90255380
        ], (6, 6))',
        "Saturn" => reshape([
            -0.99620412
            0.02275182
            0.08402210
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            -0.01645380
            -0.99705510
            0.07490256
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            0.08547883
            0.07323576
            0.99364475
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            -2.69488600E-06
            -0.00016330
            1.22679155E-05
            -0.99620412
            0.02275182
            0.08402210
            0.00016316
            -3.72640641E-06
            -1.37615586E-05
            -0.01645380
            -0.99705510
            0.07490256
            3.12743406E-14
            -2.71699092E-15
            -2.49013867E-15
            0.08547883
            0.07323576
            0.99364475
        ], (6, 6))',
        "Uranus" => reshape([
            -0.91000094
            0.28785233
            -0.29839458
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            0.35630671
            0.17494968
            -0.91784429
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            -0.21199958
            -0.94155916
            -0.26176809
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            -3.60714918E-05
            -1.77114146E-05
            9.29199819E-05
            -0.91000094
            0.28785233
            -0.29839458
            -9.21259430E-05
            2.91413627E-05
            -3.02086310E-05
            0.35630671
            0.17494968
            -0.91784429
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            -0.21199958
            -0.94155916
            -0.26176809
        ], (6, 6))',
        "Neptune" => reshape([
            0.16782169
            -0.67394650
            -0.71946646
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            0.91829122
            0.37233151
            -0.13457519
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            0.35857651
            -0.63809510
            0.68136446
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            9.94860666E-05
            4.03377447E-05
            -1.45796407E-05
            0.16782169
            -0.67394650
            -0.71946646
            -1.81815093E-05
            7.30141884E-05
            7.79457377E-05
            0.91829122
            0.37233151
            -0.13457519
            2.28629820E-12
            1.20926573E-12
            -7.07202958E-14
            0.35857651
            -0.63809510
            0.68136446
        ], (6, 6))',
        "GCRF" => reshape([
            0.24742306
            0.96890755
            3.08055248E-09
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            -0.96890755
            0.24742306
            -1.09209406E-17
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            -7.62199719E-10
            -2.98477054E-09
            1.00000000
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            7.06538526E-05
            -1.80423738E-05
            3.08055237E-12
            0.24742306
            0.96890755
            3.08055248E-09
            1.80423738E-05
            7.06538526E-05
            -2.18418808E-20
            -0.96890755
            0.24742306
            -1.09209406E-17
            -9.79852602E-13
            -2.92918995E-12
            -9.48980323E-21
            -7.62199719E-10
            -2.98477054E-09
            1.00000000
        ], (6, 6))',
        "Moon" => reshape([
            0.78257370
            0.55976292
            0.27247730
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            -0.62214730
            0.71906872
            0.30963351
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            -0.02260855
            -0.41183206
            0.91097926
            0.00000000E+00
            0.00000000E+00
            0.00000000E+00
            -1.65612960E-06
            1.91382763E-06
            8.24852982E-07
            0.78257370
            0.55976292
            0.27247730
            -2.08318236E-06
            -1.49049154E-06
            -7.24341598E-07
            -0.62214730
            0.71906872
            0.30963351
            1.24731231E-10
            -1.15606661E-09
            -5.19534660E-10
            -0.02260855
            -0.41183206
            0.91097926
        ], (6, 6))',
        )
        for planet in Astrodynamics.PLANETS
            p = Symbol(planet)
            @eval begin
                @test rotation_matrix(IAU{$p}, GCRF, $ep) ≈ $matrices[$planet]
            end
        end
        for satellite in Astrodynamics.SATELLITES
            s = Symbol(satellite)
            @eval begin
                @test rotation_matrix(IAU{$s}, GCRF, $ep) ≈ $matrices[$satellite]
            end
        end
        @test rotation_matrix(GCRF, IAU{Earth}, ep) ≈ matrices["GCRF"]
    end
    @testset "Terrestial Rotations" begin
        # Reference values from Orekit (http://www.orekit.org)
        tdb = TDBEpoch(2013, 3, 18, 12, 0, 0.0)
        rv = [8.59072560e+02, -4.13720368e+03, 5.29556871e+03, 7.37289205e+00,
            2.08223573e+00, 4.39999794e-01]
        gcrf_cirf = rotation_matrix(CIRF, GCRF, tdb)
        ref_gcrf_cirf = [0.9999991427733881 -1.144503732190422E-8 -0.0013093710276537447;
            4.871197292135239E-8 0.9999999995949649 2.8461675919057616E-5;
            0.001309371026797659 -2.8461715302997654E-5 0.9999991423683543]
        rv_cirf = [852.1380066867667, -4137.052915716736, 5296.806764985966,
            7.372309565810324, 2.08224861625441, 0.4495940103957848]
        @test gcrf_cirf[1:3,1:3] ≈ ref_gcrf_cirf
        @test gcrf_cirf*rv ≈ rv_cirf
        cirf_tirf = rotation_matrix(TIRF, CIRF, tdb)
        ref_cirf_tirf = [0.9972630428201841 -0.0739352650974288 0.0;
            0.0739352650974288 0.9972630428201841 0.0;
            0.0 0.0 0.9999999999999998]
        rv_tirf = [1155.6798454967793, -4062.7269296118056, 5296.806764985964,
            6.901921544550409, 2.537349749040834, 0.44959401039578467]
        @test cirf_tirf[1:3,1:3] ≈ ref_cirf_tirf
        @test cirf_tirf*rv_cirf ≈ rv_tirf
        tirf_itrf = rotation_matrix(ITRF, TIRF, tdb)
        ref_tirf_itrf = [0.9999999999999787 -3.010092334926554E-11 2.0567742763960954E-7;
            3.046034574888695E-11 0.999999999998473 -1.7475053232215554E-6;
            -2.0567742758669397E-7 1.7475053232277836E-6 0.9999999999984519]
        rv_itrf = [1155.6809350526369, -4062.7361857684173, 5296.799427643569,
            6.9019216369452225, 2.537348963579269, 0.4495970248578132]
        @test tirf_itrf[1:3,1:3] ≈ ref_tirf_itrf
        @test tirf_itrf*rv_tirf ≈ rv_itrf
        s_gcrf = State(tdb, rv)
        s_cirf = State(tdb, rv_cirf, CIRF)
        s_tirf = State(tdb, rv_tirf, TIRF)
        s_itrf = State(tdb, rv_itrf, ITRF)
        @test s_gcrf ≈ State(State(s_gcrf, frame=CIRF), frame=GCRF)
        @test s_cirf ≈ State(State(s_cirf, frame=TIRF), frame=CIRF)
        @test s_tirf ≈ State(State(s_tirf, frame=ITRF), frame=TIRF)
        @test s_gcrf ≈ State(State(s_gcrf, frame=ITRF), frame=GCRF)
    end
end
